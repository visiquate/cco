# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Claude Army** is a sophisticated multi-agent development system featuring **15 specialized agents** in a TDD-aware pipeline:

### Phase 0: Independent (1 Agent)
- **Chief Architect** (Opus 4.1 → Sonnet 4.5 fallback) - Strategic decision-making and coordination

### Phase 1: Coding & Integration (10 Agents)
All use **qwen2.5-coder:32b-instruct** (32B, 32k context) via `claude-3-5-sonnet` API alias:
1. **TDD Coding Agent** - Test-driven development specialist
2. **Python Expert** - FastAPI, Django, ML/AI integration
3. **Swift Expert** - SwiftUI, UIKit, iOS development
4. **Go Expert** - Microservices, cloud-native apps
5. **Rust Expert** - Systems programming, performance-critical code
6. **Flutter Expert** - Cross-platform mobile development
7. **API Explorer** - Third-party API integration analysis
8. **Salesforce API Expert** - Salesforce REST/SOAP/Bulk API
9. **Authentik API Expert** - OAuth2/OIDC, SAML integration
10. **DevOps Engineer** - Docker, Kubernetes, AWS, CI/CD

### Phase 1: Lightweight (1 Agent)
Uses **qwen-fast:latest** (7B, 32k context) via `claude-3-haiku` API alias:
11. **Credential Manager** - Secure secrets management

### Phase 2: Reasoning & Quality (3 Agents)
All use **qwen-quality-128k:latest** (32B, 128k context) via `gpt-4` API alias:
13. **QA Engineer** - Integration testing, E2E tests, autonomous test fixing
14. **Security Auditor** - Vulnerability scanning, OWASP compliance
15. **Documentation Lead** - API reference, code documentation

This system uses Claude Code's Task tool for parallel agent execution with MCP coordination, routed through **ccproxy** (LiteLLM) to local Ollama qwen models for efficient, high-quality development.

## Quick Start

When a user describes what they want to build, Claude Code should:

1. **Initialize MCP coordination** (if complex task):
   ```javascript
   mcp__claude-flow__swarm_init({ topology: "hierarchical", maxAgents: 15 })
   ```

2. **Spawn ALL agents in a SINGLE message** using Claude Code's Task tool:
   - Chief Architect (opus → sonnet-4.5 fallback) - leads the design
   - Phase 1 coding agents (model="sonnet-4.5") - routes to qwen2.5-coder via ccproxy
   - Phase 1 lightweight agent (model="haiku") - routes to qwen-fast via ccproxy
   - Phase 2 reasoning agents (model="gpt-4") - routes to qwen-quality-128k via ccproxy

3. **Include TodoWrite** with 10-20 todos covering all phases

4. **Each agent follows coordination protocol** using hooks and shared memory

## ccproxy Model Routing

The army routes agent requests through **ccproxy** (LiteLLM proxy at `https://coder.visiquate.com`) which maps API aliases to local Ollama models:

| API Alias | Ollama Model | Agents | Context | Phase |
|-----------|-------------|--------|---------|-------|
| `claude-3-5-sonnet` | qwen2.5-coder:32b-instruct | 1-10 (TDD, Python, Swift, Go, Rust, Flutter, APIs, DevOps) | 32k | Phase 1 |
| `claude-3-haiku` | qwen-fast:latest | 11 (Credential Manager) | 32k | Phase 1 |
| `gpt-4` | qwen-quality-128k:latest | 13-15 (QA, Security, Docs) | 128k | Phase 2 |

**Memory Strategy:**
- **Phase 1**: qwen2.5-coder (20GB) + qwen-fast (5GB) = 25GB ✅ Both loaded simultaneously
- **Phase 2**: qwen-quality-128k (35GB) loads, qwen2.5-coder auto-unloads
- **Health checks disabled** to prevent model thrashing

## Agent Configuration

All agent roles, capabilities, and models are defined in `config/army-config.json`:

### Phase 0: Independent
- **Chief Architect**: system-architect type, opus → sonnet-4.5 fallback

### Phase 1: Coding (model="sonnet-4.5" → qwen2.5-coder:32b-instruct)
1. **TDD Coding Agent**: coder type
2. **Python Expert**: python-expert type
3. **Swift Expert**: ios-developer type
4. **Go Expert**: backend-dev type
5. **Rust Expert**: backend-dev type
6. **Flutter Expert**: mobile-developer type
7. **API Explorer**: researcher type
8. **Salesforce API Expert**: backend-dev type
9. **Authentik API Expert**: backend-dev type
10. **DevOps Engineer**: deployment-engineer type

### Phase 1: Lightweight (model="haiku" → qwen-fast:latest)
11. **Credential Manager**: coder type

### Phase 2: Reasoning (model="gpt-4" → qwen-quality-128k:latest)
13. **QA Engineer**: test-automator type
14. **Security Auditor**: security-auditor type
15. **Documentation Lead**: coder type

## MCP Server Configuration

### Currently Disabled (in `.claude/settings.local.json`)
- `claude-flow@alpha` - Multi-agent workflow orchestration
- `ruv-swarm` - Enhanced swarm coordination
- `flow-nexus` - Cloud-based orchestration features
- `agentic-payments` - Payment processing capabilities

### Recommended Setup
Enable `claude-flow@alpha` and `ruv-swarm` by removing them from the disabled list:

```json
{
  "disabledMcpjsonServers": [
    "flow-nexus",
    "agentic-payments"
  ]
}
```

## Common Commands

### Credential Management
```bash
# Store a credential
npm run credentials store <key> <value> [type]

# Retrieve a credential
npm run credentials retrieve <key>

# List all credentials
npm run credentials list

# Check rotation status
npm run credentials check-rotation
```

### Army Orchestration
```bash
# View army configuration
npm run army

# Generate workflow for a requirement
node src/army-orchestrator.js "Build a REST API with auth"

# View usage guide
npm run help
```

### MCP Operations
```bash
# Initialize swarm coordination
npx claude-flow@alpha swarm init --topology hierarchical

# Check swarm status
npx claude-flow@alpha swarm status

# View shared memory
npx claude-flow@alpha memory list

# Store/retrieve from memory
npx claude-flow@alpha memory store --key "key" --value "value"
npx claude-flow@alpha memory retrieve --key "key"
```

## Agent Coordination Protocol

Every agent MUST follow this protocol:

### Before Work
```bash
npx claude-flow@alpha hooks pre-task --description "task description"
npx claude-flow@alpha memory retrieve --key "architect/decisions"
```

### During Work
```bash
# After editing files
npx claude-flow@alpha hooks post-edit --file "filename"

# Store progress/decisions
npx claude-flow@alpha memory store --key "agent-name/progress" --value '{"status": "complete"}'
```

### After Work
```bash
# Notify other agents
npx claude-flow@alpha hooks notify --message "Feature X complete"

# Complete task
npx claude-flow@alpha hooks post-task --task-id "task-id"
```

## Credential Management

**CRITICAL SECURITY RULES:**
- **NEVER** hardcode credentials in source code
- **ALWAYS** use the credential manager (`src/credential-manager.js`)
- Store credentials in `/tmp/credentials.json` (development only)
- Use environment variables in production
- Track all credentials in the inventory
- Coordinate with Security Auditor on credential usage

The credential manager provides:
- AES-256-CBC encryption
- Secure file permissions (600)
- Rotation tracking
- Expiration monitoring
- Automatic inventory management

## Architecture

```
┌────────────────────────────────────────────────────────┐
│    Chief Architect (Opus 4.1 → Sonnet 4.5 fallback)   │
│          Strategic Decisions & Coordination            │
│                  (Claude API direct)                   │
└────────────────────┬───────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
┌───────▼──────────┐    ┌────────▼────────────┐
│   PHASE 1 (10)   │    │   PHASE 1 (1)       │
│   qwen2.5-coder  │    │   qwen-fast         │
│   32B, 32k       │    │   7B, 32k           │
├──────────────────┤    ├─────────────────────┤
│ 1. TDD Agent     │    │ 11. Credentials     │
│ 2. Python        │    └─────────────────────┘
│ 3. Swift         │
│ 4. Go            │    ┌─────────────────────┐
│ 5. Rust          │    │   PHASE 2 (3)       │
│ 6. Flutter       │    │   qwen-quality-128k │
│ 7. API Explorer  │    │   32B, 128k         │
│ 8. Salesforce    │    ├─────────────────────┤
│ 9. Authentik     │    │ 13. QA Engineer     │
│ 10. DevOps       │    │ 14. Security        │
└──────────────────┘    │ 15. Documentation   │
                        └─────────────────────┘

All agents (except Architect) route through:
  ccproxy → https://coder.visiquate.com → Ollama (Mac mini)
```

### TDD-Aware Coordination Flow

1. **User provides requirement** → Claude Code receives request
2. **MCP initializes topology** → Hierarchical structure with Architect as leader (15 agents)
3. **All agents spawn in parallel** → Using Claude Code's Task tool (ONE message)
4. **Architect analyzes and designs** → Stores decisions in shared memory (direct Claude API)
5. **Phase 1 begins** → TDD Agent writes tests FIRST, then coding agents implement
   - 10 coding agents use qwen2.5-coder (32B) via claude-3-5-sonnet
   - 1 credential agent uses qwen-fast (7B) via claude-3-haiku
   - Both models stay loaded in memory (~25GB total)
6. **Phase 2 begins** → Quality assurance and documentation
   - 3 reasoning agents use qwen-quality-128k (32B) via gpt-4
   - qwen2.5-coder auto-unloads, qwen-quality-128k loads (~35GB)
7. **Architect reviews and approves** → Final quality check before completion

**Key TDD Principle**: Tests written BEFORE implementation in Phase 1

## File Organization

```
claude-army/
├── config/
│   ├── army-config.json          # Agent definitions and roles
│   └── credential-inventory.json # Credential tracking (gitignored)
├── src/
│   ├── army-orchestrator.js      # Main orchestration system
│   └── credential-manager.js     # Secure credential management
├── docs/
│   ├── ARMY_USAGE_GUIDE.md       # Comprehensive usage guide
│   └── EXAMPLE_WORKFLOW.md       # Full example workflow
├── tests/                         # Future test files
├── scripts/                       # Utility scripts
└── .github/workflows/            # Future CI/CD workflows
```

## Example Usage

### Simple Request (TDD)
```
User: "Add JWT authentication to a Python API"

Claude Code spawns (6 agents):
- Architect: Designs auth flow (Claude API)
- TDD Agent: Writes auth tests FIRST (qwen2.5-coder)
- Python Expert: Implements JWT with FastAPI (qwen2.5-coder)
- Credentials: Manages JWT secret (qwen-fast)
- Security Auditor: Reviews security (qwen-quality-128k)
- QA: Validates test coverage (qwen-quality-128k)
- Docs: Documents auth endpoints (qwen-quality-128k)
```

### Complex Request (Full TDD Pipeline)
```
User: "Build a mobile app (Flutter) with Go backend and Python ML service"

Claude Code spawns (all 15 agents):

Phase 0:
- Architect: Designs 3-tier architecture (Claude API)

Phase 1 (qwen2.5-coder + qwen-fast, ~25GB):
- TDD Agent: Writes comprehensive test suite FIRST
- Flutter Expert: Mobile app (after tests written)
- Go Expert: REST API backend (after tests written)
- Python Expert: ML inference service (after tests written)
- API Explorer: Analyzes integration points
- DevOps: Configures Docker/K8s
- Credentials: Manages all secrets (qwen-fast)

Phase 2 (qwen-quality-128k, ~35GB):
- QA: Full integration and E2E testing
- Security: Complete security audit
- Docs: System documentation

Result: Complete TDD-compliant system with tests, security, and docs
```

## Best Practices

1. ✅ **Always spawn agents in parallel** - One message with all Task calls
2. ✅ **Let the Architect lead** - Don't micromanage coding agents
3. ✅ **Use shared memory** - Enable cross-agent communication
4. ✅ **Enable hooks** - Automatic coordination and tracking
5. ✅ **Security first** - Always include Security Auditor
6. ✅ **Never hardcode credentials** - Use credential manager
7. ✅ **Document as you build** - Documentation agent runs in parallel
8. ✅ **Test everything** - QA agent ensures quality

## Performance Characteristics

- **Agent Spawn**: Instant (parallel execution in one message)
- **Speed**: 2.8-4.4x faster than sequential development
- **Token Reduction**: ~32% with shared memory
- **Coordination Overhead**: Minimal with hooks
- **Success Rate**: High quality with built-in QA and security

## Documentation

- [README.md](README.md) - Project overview and quick start
- [docs/ARMY_USAGE_GUIDE.md](docs/ARMY_USAGE_GUIDE.md) - Comprehensive usage guide
- [docs/ARMY_ROSTER_TDD.md](docs/ARMY_ROSTER_TDD.md) - 15-agent TDD pipeline details
- [docs/TDD_AWARE_PIPELINE.md](docs/TDD_AWARE_PIPELINE.md) - TDD methodology guide
- [docs/DEPLOYMENT_STATUS.md](docs/DEPLOYMENT_STATUS.md) - ccproxy deployment status
- [config/army-config.json](config/army-config.json) - Agent configuration with ccproxy mappings

## ccproxy Deployment

The army's model routing is deployed on Mac mini at `192.168.9.123`:
- **Public URL**: https://coder.visiquate.com
- **ccproxy**: LiteLLM proxy on localhost:8081
- **Ollama**: Local LLM server on localhost:11434
- **Traefik**: TLS termination and bearer token auth
- **Health checks**: Disabled to prevent model thrashing
- **Deployment**: Automated via Watchtower (polls GHCR every 30s)

## Future Enhancements

- Expand to 20+ specialized agents (database-admin, data-engineer, etc.)
- Integrate with flow-nexus for cloud execution
- Add neural training for pattern learning from successful TDD cycles
- GitHub integration for PR management and automated code review
- Automated deployment workflows with zero-downtime updates
