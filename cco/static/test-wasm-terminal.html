<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Terminal Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1b26;
            color: #a9b1d6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 20px;
            color: #7aa2f7;
        }

        .controls {
            background: #24283b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            background: #7aa2f7;
            color: #1a1b26;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background: #89b4fa;
        }

        button:active {
            background: #5a8ee6;
        }

        .status {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        .status.connected {
            background: rgba(157, 240, 166, 0.2);
            color: #9df0a6;
        }

        .status.disconnected {
            background: rgba(247, 118, 142, 0.2);
            color: #f7768e;
        }

        .terminal-wrapper {
            background: #1a1b26;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #terminal-container {
            background: #000000;
            min-height: 400px;
            border-radius: 4px;
            position: relative;
        }

        canvas {
            display: block;
            border: none;
            outline: none;
        }

        .info-panel {
            background: #24283b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .info-panel h3 {
            color: #7aa2f7;
            margin-bottom: 10px;
        }

        .info-panel pre {
            background: #1a1b26;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            color: #9ece6a;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #565f89;
        }

        .error {
            background: rgba(247, 118, 142, 0.2);
            color: #f7768e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: rgba(157, 240, 166, 0.2);
            color: #9df0a6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WASM Terminal Test</h1>

        <div id="message-area"></div>

        <div class="controls">
            <button id="connect-btn">Connect WebSocket</button>
            <button id="disconnect-btn">Disconnect</button>
            <button id="clear-btn">Clear Terminal</button>
            <button id="test-input-btn">Test Input</button>
            <button id="test-colors-btn">Test Colors</button>
            <button id="test-cursor-btn">Test Cursor Movement</button>
            <button id="test-256-colors-btn">Test 256 Colors</button>
            <button id="test-rgb-colors-btn">Test RGB Colors</button>
            <button id="test-attributes-btn">Test Attributes</button>
            <button id="test-performance-btn">Performance Test</button>
            <div class="status disconnected" id="status">Disconnected</div>
        </div>

        <div class="terminal-wrapper">
            <div id="terminal-container"></div>
        </div>

        <div class="info-panel">
            <h3>System Information</h3>
            <pre id="info">Initializing...</pre>
        </div>

        <div class="info-panel">
            <h3>Event Log</h3>
            <pre id="log">Waiting for events...</pre>
        </div>
    </div>

    <!-- Load scripts -->
    <script src="/static/wasm-terminal.js"></script>
    <script src="/static/terminal-adapter.js"></script>
    <script>
        let terminal = null;
        let adapter = null;
        const logLines = [];
        const maxLogLines = 20;

        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${level.toUpperCase()}: ${message}`;
            logLines.unshift(logEntry);
            if (logLines.length > maxLogLines) {
                logLines.pop();
            }
            document.getElementById('log').textContent = logLines.join('\n');
            console.log(logEntry);
        }

        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            messageArea.innerHTML = '';
            messageArea.appendChild(div);

            setTimeout(() => {
                div.remove();
            }, 5000);
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            if (connected) {
                status.textContent = 'Connected';
                status.className = 'status connected';
            } else {
                status.textContent = 'Disconnected';
                status.className = 'status disconnected';
            }
        }

        function updateInfo() {
            const info = {
                'Browser': navigator.userAgent.split(' ').slice(-2).join(' '),
                'WebAssembly Support': typeof WebAssembly !== 'undefined' ? 'Yes' : 'No',
                'Canvas Support': !!window.CanvasRenderingContext2D,
                'Terminal Type': terminal ? 'WASM' : 'Not initialized',
                'Terminal Dimensions': terminal ? `${terminal.config.cols}x${terminal.config.rows}` : 'N/A'
            };

            const infoText = Object.entries(info)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');

            document.getElementById('info').textContent = infoText;
        }

        async function initTerminal() {
            try {
                log('Initializing WASM terminal...');

                const preference = TerminalManager.getPreference();
                log(`Terminal preference: ${preference}`);

                adapter = await TerminalManager.create('terminal-container', preference);
                terminal = adapter.terminal;

                log('Terminal initialized successfully');
                showMessage('Terminal initialized successfully', 'success');

                // Setup callbacks
                adapter.onConnect = () => {
                    log('WebSocket connected');
                    updateStatus(true);
                    showMessage('WebSocket connected', 'success');
                };

                adapter.onDisconnect = () => {
                    log('WebSocket disconnected');
                    updateStatus(false);
                    showMessage('WebSocket disconnected', 'error');
                };

                adapter.onError = (error) => {
                    log(`Error: ${error.message}`, 'error');
                    showMessage(`Error: ${error.message}`, 'error');
                };

                updateInfo();
            } catch (error) {
                log(`Initialization error: ${error.message}`, 'error');
                showMessage(`Failed to initialize terminal: ${error.message}`, 'error');
                console.error('Initialization error:', error);
            }
        }

        // Connect button
        document.getElementById('connect-btn').addEventListener('click', async () => {
            if (!adapter) {
                showMessage('Terminal not initialized', 'error');
                return;
            }

            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/terminal`;
                log(`Connecting to ${wsUrl}...`);
                await adapter.connect(wsUrl);
            } catch (error) {
                log(`Connection error: ${error.message}`, 'error');
                showMessage(`Connection failed: ${error.message}`, 'error');
            }
        });

        // Disconnect button
        document.getElementById('disconnect-btn').addEventListener('click', () => {
            if (adapter) {
                adapter.close();
                log('Disconnected manually');
            }
        });

        // Clear button
        document.getElementById('clear-btn').addEventListener('click', () => {
            if (adapter) {
                adapter.clear();
                log('Terminal cleared');
            }
        });

        // Test input button
        document.getElementById('test-input-btn').addEventListener('click', () => {
            if (terminal) {
                terminal.write('Hello, WASM Terminal!\r\n');
                terminal.write('This is a test message.\r\n');
                terminal.write('Line 3\r\n');
                log('Test input written to terminal');
            }
        });

        // Test colors button
        document.getElementById('test-colors-btn').addEventListener('click', () => {
            if (terminal) {
                terminal.write('\x1b[31mRed text\x1b[0m\r\n');
                terminal.write('\x1b[32mGreen text\x1b[0m\r\n');
                terminal.write('\x1b[33mYellow text\x1b[0m\r\n');
                terminal.write('\x1b[34mBlue text\x1b[0m\r\n');
                terminal.write('\x1b[35mMagenta text\x1b[0m\r\n');
                terminal.write('\x1b[36mCyan text\x1b[0m\r\n');
                terminal.write('\x1b[1mBold text\x1b[0m\r\n');
                terminal.write('\x1b[4mUnderlined text\x1b[0m\r\n');
                log('Color test written to terminal');
            }
        });

        // Test cursor movement button
        document.getElementById('test-cursor-btn').addEventListener('click', () => {
            if (terminal) {
                terminal.write('\x1b[2J\x1b[H'); // Clear screen and move to home
                terminal.write('Testing cursor movement...\r\n');
                terminal.write('Line 2\r\n');
                terminal.write('Line 3\r\n');
                terminal.write('\x1b[A'); // Move up
                terminal.write('(inserted after move up)\r\n');
                log('Cursor movement test written to terminal');
            }
        });

        // Phase 2: Test 256 colors
        document.getElementById('test-256-colors-btn').addEventListener('click', () => {
            if (terminal) {
                terminal.write('\x1b[2J\x1b[H'); // Clear screen
                terminal.write('=== 256 Color Palette Test ===\r\n\r\n');

                // Test standard colors (0-15)
                terminal.write('Standard Colors (0-15):\r\n');
                for (let i = 0; i < 16; i++) {
                    terminal.write(`\x1b[38;5;${i}m${i.toString().padStart(3, ' ')} `);
                    if ((i + 1) % 8 === 0) terminal.write('\r\n');
                }
                terminal.write('\x1b[0m\r\n');

                // Test 6x6x6 color cube (16-231)
                terminal.write('\r\n6x6x6 Color Cube (16-231):\r\n');
                for (let i = 16; i < 232; i++) {
                    terminal.write(`\x1b[48;5;${i}m  `);
                    if ((i - 15) % 36 === 0) terminal.write('\x1b[0m\r\n');
                }
                terminal.write('\x1b[0m\r\n');

                // Test grayscale (232-255)
                terminal.write('\r\nGrayscale Ramp (232-255):\r\n');
                for (let i = 232; i < 256; i++) {
                    terminal.write(`\x1b[48;5;${i}m  `);
                }
                terminal.write('\x1b[0m\r\n');

                log('256-color test written to terminal');
            }
        });

        // Phase 2: Test RGB colors
        document.getElementById('test-rgb-colors-btn').addEventListener('click', () => {
            if (terminal) {
                terminal.write('\x1b[2J\x1b[H'); // Clear screen
                terminal.write('=== RGB True Color Test ===\r\n\r\n');

                // Test RGB foreground colors
                terminal.write('RGB Foreground Colors:\r\n');
                terminal.write('\x1b[38;2;255;0;0mRed (255,0,0)\x1b[0m\r\n');
                terminal.write('\x1b[38;2;0;255;0mGreen (0,255,0)\x1b[0m\r\n');
                terminal.write('\x1b[38;2;0;0;255mBlue (0,0,255)\x1b[0m\r\n');
                terminal.write('\x1b[38;2;255;255;0mYellow (255,255,0)\x1b[0m\r\n');
                terminal.write('\x1b[38;2;255;0;255mMagenta (255,0,255)\x1b[0m\r\n');
                terminal.write('\x1b[38;2;0;255;255mCyan (0,255,255)\x1b[0m\r\n');

                // Test RGB background colors
                terminal.write('\r\nRGB Background Colors:\r\n');
                terminal.write('\x1b[48;2;255;0;0m Red BG \x1b[0m ');
                terminal.write('\x1b[48;2;0;255;0m Green BG \x1b[0m ');
                terminal.write('\x1b[48;2;0;0;255m Blue BG \x1b[0m\r\n');

                // Test gradient
                terminal.write('\r\nRGB Gradient:\r\n');
                for (let i = 0; i < 50; i++) {
                    const r = Math.floor((i / 50) * 255);
                    const g = Math.floor((1 - i / 50) * 255);
                    const b = 128;
                    terminal.write(`\x1b[48;2;${r};${g};${b}m `);
                }
                terminal.write('\x1b[0m\r\n');

                log('RGB color test written to terminal');
            }
        });

        // Phase 2: Test advanced attributes
        document.getElementById('test-attributes-btn').addEventListener('click', () => {
            if (terminal) {
                terminal.write('\x1b[2J\x1b[H'); // Clear screen
                terminal.write('=== Advanced Text Attributes Test ===\r\n\r\n');

                terminal.write('\x1b[1mBold text\x1b[0m\r\n');
                terminal.write('\x1b[2mDim text\x1b[0m\r\n');
                terminal.write('\x1b[3mItalic text\x1b[0m\r\n');
                terminal.write('\x1b[4mUnderlined text\x1b[0m\r\n');
                terminal.write('\x1b[5mBlinking text\x1b[0m\r\n');
                terminal.write('\x1b[7mReverse video\x1b[0m\r\n');
                terminal.write('\x1b[8mHidden text (you should not see this)\x1b[0m\r\n');
                terminal.write('\x1b[9mStrikethrough text\x1b[0m\r\n');

                terminal.write('\r\nCombined Attributes:\r\n');
                terminal.write('\x1b[1;3;4mBold + Italic + Underline\x1b[0m\r\n');
                terminal.write('\x1b[1;31mBold Red\x1b[0m\r\n');
                terminal.write('\x1b[3;32mItalic Green\x1b[0m\r\n');
                terminal.write('\x1b[4;34mUnderlined Blue\x1b[0m\r\n');
                terminal.write('\x1b[1;7;33mBold Reverse Yellow\x1b[0m\r\n');

                log('Advanced attributes test written to terminal');
            }
        });

        // Phase 2: Performance test
        document.getElementById('test-performance-btn').addEventListener('click', () => {
            if (terminal) {
                log('Starting performance test...');

                // Clear and fill screen with colorful text
                terminal.write('\x1b[2J\x1b[H');

                const startTime = performance.now();
                let charCount = 0;

                // Fill screen with various colors and attributes
                for (let row = 0; row < 20; row++) {
                    for (let col = 0; col < 70; col++) {
                        const colorIdx = (row * 70 + col) % 256;
                        const char = String.fromCharCode(65 + (col % 26)); // A-Z
                        terminal.write(`\x1b[38;5;${colorIdx}m${char}`);
                        charCount++;
                    }
                    terminal.write('\x1b[0m\r\n');
                }

                const endTime = performance.now();
                const duration = endTime - startTime;

                // Get performance metrics
                const metrics = terminal.getPerformanceMetrics ?
                    terminal.getPerformanceMetrics() :
                    { note: 'Metrics not available' };

                terminal.write('\r\n--- Performance Results ---\r\n');
                terminal.write(`Characters rendered: ${charCount}\r\n`);
                terminal.write(`Time: ${duration.toFixed(2)}ms\r\n`);
                terminal.write(`Rate: ${(charCount / duration * 1000).toFixed(0)} chars/sec\r\n`);

                log(`Performance test completed: ${charCount} chars in ${duration.toFixed(2)}ms`);
                log(`Metrics: ${JSON.stringify(metrics)}`);
            }
        });

        // Initialize on page load
        window.addEventListener('load', async () => {
            log('Page loaded, initializing terminal...');
            await initTerminal();
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (adapter) {
                adapter.close();
            }
        });
    </script>
</body>
</html>
