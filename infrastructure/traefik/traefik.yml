# Traefik Static Configuration
# Global settings and entry points for CCO API proxy

# API and Dashboard
api:
  dashboard: true
  insecure: false  # Only accessible via HTTPS
  debug: false

# Entry points
entryPoints:
  web:
    address: ":80"
    # Redirect all HTTP to HTTPS
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
          permanent: true

  websecure:
    address: ":443"
    http:
      tls:
        certResolver: letsencrypt

# Let's Encrypt Configuration
certificatesResolvers:
  letsencrypt:
    acme:
      email: ${LETSENCRYPT_EMAIL:-admin@example.com}
      storage: /letsencrypt/acme.json
      # Use HTTP-01 challenge (port 80)
      httpChallenge:
        entryPoint: web

# Docker provider configuration
providers:
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false  # Explicitly enable with traefik.enable=true
    network: cco-network

  # Load dynamic configuration from file
  file:
    directory: /dynamic
    watch: true

# Logging
log:
  level: INFO
  format: json

# Access logs (all requests)
accessLog:
  format: json
  filePath: /dev/stdout

# Health check endpoint
ping:
  entryPoint: websecure
  path: /ping

# Global Traefik configuration
global:
  checkNewVersion: true
  sendAnonymousUsage: false

# Middleware definitions for authentication
middleware:
  # Authentik forward auth middleware
  authentik:
    forwardAuth:
      address: http://authentik-outpost:4180/outpost.goauthentik.io/auth/traefik
      trustForwardHeader: true
      authResponseHeaders:
        - Remote-User
        - Remote-Groups
        - Remote-Name
        - Remote-Email
      authRequestHeaders:
        - Cookie

# Security headers middleware
securityHeaders:
  customResponseHeaders:
    X-Content-Type-Options: "nosniff"
    X-Frame-Options: "DENY"
    X-XSS-Protection: "1; mode=block"
    Referrer-Policy: "strict-origin-when-cross-origin"
    Permissions-Policy: "geolocation=(), microphone=(), camera=()"
    Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
