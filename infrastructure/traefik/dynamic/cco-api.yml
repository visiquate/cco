# Traefik Dynamic Configuration for CCO Releases API
# Routes authenticated requests to the releases API service
# Loaded dynamically by Traefik from /dynamic directory

http:
  routers:
    cco-api:
      rule: "Host(`cco-api.visiquate.com`)"
      entryPoints:
        - websecure
      service: cco-releases-api
      tls:
        certResolver: letsencrypt
      middlewares:
        - authentik
        - cco-rate-limit
        - cco-headers
      priority: 100

    # Catch-all for root path - return 404
    # No index page to prevent discovery
    cco-api-root:
      rule: "Host(`cco-api.visiquate.com`) && Path(`/`)"
      entryPoints:
        - websecure
      service: cco-not-found
      tls:
        certResolver: letsencrypt
      priority: 200  # Higher priority to match first

  services:
    cco-releases-api:
      loadBalancer:
        servers:
          - url: "http://cco-releases-api:8000"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 10s

    # Service that always returns 404
    cco-not-found:
      staticResponses:
        middleware: cco-not-found-middleware

  middlewares:
    # Authentik forward authentication
    authentik:
      forwardAuth:
        address: "http://authentik-outpost:4180/outpost.goauthentik.io/auth/traefik"
        trustForwardHeader: true
        authResponseHeaders:
          - Remote-User
          - Remote-Groups
          - Remote-Name
          - Remote-Email
        authRequestHeaders:
          - Cookie
        # Redirect to Authentik login on failed auth
        authResponseHeadersRegex: "^Remote-"

    # Rate limiting (prevent abuse)
    cco-rate-limit:
      rateLimit:
        average: 100  # requests per second (per client)
        burst: 200
        period: 60
        # Apply to source IP
        sourceCriterion:
          ipStrategy:
            # Trust X-Forwarded-For header from Traefik
            excludedIPs:
              - "127.0.0.1/32"

    # Security headers
    cco-headers:
      headers:
        customResponseHeaders:
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "DENY"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
          Cache-Control: "no-cache, no-store, must-revalidate"
          Pragma: "no-cache"
          Expires: "0"
        accessControlAllowOriginList:
          - "https://cco-api.visiquate.com"
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "OPTIONS"
        accessControlAllowHeaders:
          - "Authorization"
          - "Content-Type"
        accessControlMaxAge: 3600

    # 404 response for root path
    cco-not-found-middleware:
      staticResponses:
        statusCode: 404
        contentType: "application/json"
        body: |
          {
            "error": "not_found",
            "message": "This endpoint is not publicly available",
            "documentation": "See https://github.com/visiquate/cco/docs for CCO CLI integration"
          }

# TCP Services (if needed for non-HTTP protocols)
tcp:
  # Not used for Releases API, but kept for reference
  # Can be extended if needed for additional services

# UDP Services (if needed)
udp:
  # Not used for Releases API, but kept for reference
  # Can be extended if needed for additional services
