name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

# Cancel in-progress runs when a new workflow with the same group name is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  secret-scanning:
    name: Secret Detection with TruffleHog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive secret scanning

      - name: Run TruffleHog secret scanner
        run: |
          # Install TruffleHog
          docker pull ghcr.io/trufflesecurity/trufflehog:latest

          # Determine scan parameters based on event type
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "Scanning PR commits from ${{ github.event.pull_request.base.sha }} to ${{ github.event.pull_request.head.sha }}"
            docker run --rm -v "$PWD:/scan" ghcr.io/trufflesecurity/trufflehog:latest \
              git file:///scan \
              --since-commit=${{ github.event.pull_request.base.sha }} \
              --branch=${{ github.event.pull_request.head.sha }} \
              --only-verified \
              --fail
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "Scanning push commits from ${{ github.event.before }} to ${{ github.sha }}"
            docker run --rm -v "$PWD:/scan" ghcr.io/trufflesecurity/trufflehog:latest \
              git file:///scan \
              --since-commit=${{ github.event.before }} \
              --branch=${{ github.sha }} \
              --only-verified \
              --fail
          else
            echo "Scanning entire repository history"
            docker run --rm -v "$PWD:/scan" ghcr.io/trufflesecurity/trufflehog:latest \
              git file:///scan \
              --only-verified \
              --fail
          fi
        continue-on-error: false

      - name: TruffleHog results summary
        if: always()
        run: |
          echo "## TruffleHog Secret Scanning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "TruffleHog scanned the repository for exposed secrets." >> $GITHUB_STEP_SUMMARY
          echo "- Scan completed successfully âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- If secrets were found, the workflow would have failed" >> $GITHUB_STEP_SUMMARY

  dependency-security:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: npm-audit
        run: |
          echo "Running npm audit for security vulnerabilities..."
          npm audit --audit-level=moderate --json > audit-results.json || true

          # Parse and display results
          VULNERABILITIES=$(cat audit-results.json | jq -r '.metadata.vulnerabilities | to_entries[] | "\(.key): \(.value)"')

          echo "## NPM Audit Results" > audit-summary.txt
          echo "" >> audit-summary.txt
          echo "\`\`\`" >> audit-summary.txt
          echo "$VULNERABILITIES" >> audit-summary.txt
          echo "\`\`\`" >> audit-summary.txt

          cat audit-summary.txt

          # Check for critical or high vulnerabilities
          CRITICAL=$(cat audit-results.json | jq -r '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat audit-results.json | jq -r '.metadata.vulnerabilities.high // 0')

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical and $HIGH high severity vulnerabilities"
            npm audit --audit-level=moderate
            exit 1
          fi
        continue-on-error: false

      - name: Check for outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          npm outdated || echo "Some dependencies are outdated"
        continue-on-error: true

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: audit-results.json
          retention-days: 30

  file-security:
    name: File and Configuration Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check file permissions
        run: |
          echo "Checking for files with overly permissive permissions..."

          # Check for executable files that shouldn't be
          find . -type f -name "*.json" -perm -111 -not -path "./node_modules/*" -not -path "./.git/*" || true
          find . -type f -name "*.md" -perm -111 -not -path "./node_modules/*" -not -path "./.git/*" || true

          # Check for sensitive files that aren't in .gitignore
          echo "Verifying sensitive files are ignored..."

          SENSITIVE_PATTERNS=(
            "*.pem"
            "*.key"
            "*.env"
            "credentials.json"
            "secrets.json"
          )

          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if git ls-files | grep -E "$pattern" > /dev/null 2>&1; then
              echo "::warning::Sensitive file pattern '$pattern' found in git - should be in .gitignore"
            fi
          done
        continue-on-error: true

      - name: Validate .gitignore coverage
        run: |
          echo "Checking .gitignore for security-critical patterns..."

          REQUIRED_PATTERNS=(
            "*.pem"
            "*.key"
            "*.env"
            "credentials"
            "secrets"
            "node_modules"
          )

          MISSING=0
          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              echo "::warning::Pattern '$pattern' not found in .gitignore"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -eq 0 ]; then
            echo "âœ… All critical patterns are in .gitignore"
          fi
        continue-on-error: true

      - name: Check for exposed secrets in environment files
        run: |
          echo "Checking for .env files in repository..."

          if find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
            echo "::error::Found .env files in repository - these should never be committed"
            exit 1
          fi

          if find . -name ".env.*" -not -name ".env.example" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
            echo "::error::Found .env.* files in repository - only .env.example should be committed"
            exit 1
          fi

          echo "âœ… No .env files found in repository"
        continue-on-error: false

  security-summary:
    name: Security Summary
    needs: [secret-scanning, dependency-security, file-security]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate security summary
        run: |
          echo "## ðŸ”’ Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection | ${{ needs.secret-scanning.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Security | ${{ needs.dependency-security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| File Security | ${{ needs.file-security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.secret-scanning.result }}" == "success" ] && \
             [ "${{ needs.dependency-security.result }}" == "success" ] && \
             [ "${{ needs.file-security.result }}" == "success" ]; then
            echo "### âœ… All security checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some security checks failed - review the logs" >> $GITHUB_STEP_SUMMARY
          fi

  # Badge status info (add to README.md):
  # [![Security Scanning](https://github.com/yourusername/claude-orchestra/actions/workflows/security.yml/badge.svg)](https://github.com/yourusername/claude-orchestra/actions/workflows/security.yml)
