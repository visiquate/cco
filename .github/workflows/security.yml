name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scans weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

# Cancel in-progress runs when a new workflow with the same group name is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  secret-scanning:
    name: Secret Detection with TruffleHog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive secret scanning

      - name: Run TruffleHog secret scanner
        run: |
          # Install TruffleHog
          docker pull ghcr.io/trufflesecurity/trufflehog:latest

          # Determine scan parameters based on event type
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "Scanning PR commits from ${{ github.event.pull_request.base.sha }} to ${{ github.event.pull_request.head.sha }}"
            docker run --rm -v "$PWD:/scan" ghcr.io/trufflesecurity/trufflehog:latest \
              git file:///scan \
              --since-commit=${{ github.event.pull_request.base.sha }} \
              --branch=${{ github.event.pull_request.head.sha }} \
              --only-verified \
              --fail
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "Scanning push commits from ${{ github.event.before }} to ${{ github.sha }}"
            docker run --rm -v "$PWD:/scan" ghcr.io/trufflesecurity/trufflehog:latest \
              git file:///scan \
              --since-commit=${{ github.event.before }} \
              --branch=${{ github.sha }} \
              --only-verified \
              --fail
          else
            echo "Scanning entire repository history"
            docker run --rm -v "$PWD:/scan" ghcr.io/trufflesecurity/trufflehog:latest \
              git file:///scan \
              --only-verified \
              --fail
          fi
        continue-on-error: false

      - name: TruffleHog results summary
        if: always()
        run: |
          echo "## TruffleHog Secret Scanning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "TruffleHog scanned the repository for exposed secrets." >> $GITHUB_STEP_SUMMARY
          echo "- Scan completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- If secrets were found, the workflow would have failed" >> $GITHUB_STEP_SUMMARY

  rust-security:
    name: Rust Dependency Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo-audit
        id: cargo-audit
        run: |
          echo "Running cargo-audit for security vulnerabilities..."
          cargo audit --json > audit-results.json 2>&1 || true

          # Parse and display results
          if [ -f audit-results.json ]; then
            VULN_COUNT=$(jq '.vulnerabilities.count // 0' audit-results.json)
            echo "Found $VULN_COUNT vulnerabilities"

            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "::warning::Found $VULN_COUNT security vulnerabilities in Rust dependencies"
              cargo audit
            fi
          fi
        continue-on-error: true

      - name: Run cargo-deny
        run: |
          cargo install cargo-deny || true
          cargo deny check 2>&1 || echo "cargo-deny check completed with warnings"
        continue-on-error: true

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: cargo-audit-results
          path: audit-results.json
          retention-days: 30

      - name: Audit Summary
        if: always()
        run: |
          echo "## Rust Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f audit-results.json ]; then
            VULN_COUNT=$(jq '.vulnerabilities.count // 0' audit-results.json)
            echo "**Vulnerabilities Found:** $VULN_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "### Vulnerable Dependencies" >> $GITHUB_STEP_SUMMARY
              jq -r '.vulnerabilities.list[]? | "- **\(.advisory.id)**: \(.package.name)@\(.package.version) - \(.advisory.title)"' audit-results.json >> $GITHUB_STEP_SUMMARY || true
            fi
          fi

  file-security:
    name: File and Configuration Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check file permissions
        run: |
          echo "Checking for files with overly permissive permissions..."

          # Check for executable files that shouldn't be
          find . -type f -name "*.json" -perm -111 -not -path "./target/*" -not -path "./.git/*" || true
          find . -type f -name "*.md" -perm -111 -not -path "./target/*" -not -path "./.git/*" || true
          find . -type f -name "*.toml" -perm -111 -not -path "./target/*" -not -path "./.git/*" || true

          # Check for sensitive files that aren't in .gitignore
          echo "Verifying sensitive files are ignored..."

          SENSITIVE_PATTERNS=(
            "*.pem"
            "*.key"
            "*.env"
            "credentials.json"
            "secrets.json"
          )

          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if git ls-files | grep -E "$pattern" > /dev/null 2>&1; then
              echo "::warning::Sensitive file pattern '$pattern' found in git - should be in .gitignore"
            fi
          done
        continue-on-error: true

      - name: Validate .gitignore coverage
        run: |
          echo "Checking .gitignore for security-critical patterns..."

          REQUIRED_PATTERNS=(
            "*.pem"
            "*.key"
            "*.env"
            "credentials"
            "secrets"
            "target/"
          )

          MISSING=0
          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              echo "::warning::Pattern '$pattern' not found in .gitignore"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -eq 0 ]; then
            echo "All critical patterns are in .gitignore"
          fi
        continue-on-error: true

      - name: Check for exposed secrets in environment files
        run: |
          echo "Checking for .env files in repository..."

          if find . -name ".env" -not -path "./target/*" -not -path "./.git/*" | grep -q .; then
            echo "::error::Found .env files in repository - these should never be committed"
            exit 1
          fi

          if find . -name ".env.*" -not -name ".env.example" -not -path "./target/*" -not -path "./.git/*" | grep -q .; then
            echo "::error::Found .env.* files in repository - only .env.example should be committed"
            exit 1
          fi

          echo "No .env files found in repository"
        continue-on-error: false

  security-summary:
    name: Security Summary
    needs: [secret-scanning, rust-security, file-security]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate security summary
        run: |
          echo "## Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection | ${{ needs.secret-scanning.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Security | ${{ needs.rust-security.result == 'success' && 'Passed' || 'Warning' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| File Security | ${{ needs.file-security.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.secret-scanning.result }}" == "success" ] && \
             [ "${{ needs.rust-security.result }}" == "success" ] && \
             [ "${{ needs.file-security.result }}" == "success" ]; then
            echo "### All security checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Some security checks need attention - review the logs" >> $GITHUB_STEP_SUMMARY
          fi
