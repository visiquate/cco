name: Release CCO

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2025.12.4)'
        required: true
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build for each platform
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            artifact_name: cco-aarch64-apple-darwin
          - target: x86_64-unknown-linux-gnu
            os: [self-hosted, Linux, X64]
            artifact_name: cco-x86_64-unknown-linux-gnu

    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Install cross-compilation tools (macOS ARM)
        if: matrix.target == 'aarch64-apple-darwin' && runner.os == 'macOS'
        run: |
          # For ARM on macOS, we may need to set up cross-compilation
          # On Apple Silicon runners, aarch64 is native
          rustup target add ${{ matrix.target }}
          # Install protobuf compiler (required by LanceDB)
          brew install protobuf

      - name: Install cross-compilation tools (Linux)
        if: runner.os == 'Linux'
        run: |
          # Self-hosted runners should already have build tools installed via setup-runners workflow
          # This step handles different package managers gracefully
          if command -v apt-get &> /dev/null; then
            echo "Debian/Ubuntu detected, installing via apt-get..."
            sudo apt-get update
            sudo apt-get install -y musl-tools pkg-config libssl-dev protobuf-compiler || true
          elif command -v apk &> /dev/null; then
            echo "Alpine detected, installing via apk..."
            sudo apk add --no-cache build-base pkgconfig openssl-dev musl-dev protobuf-dev || true
          elif command -v yum &> /dev/null; then
            echo "CentOS/RHEL detected, installing via yum..."
            sudo yum install -y gcc gcc-c++ make pkgconfig openssl-devel protobuf-compiler || true
          else
            echo "No recognized package manager found, assuming build tools are pre-installed"
          fi
          # Verify essential tools exist
          echo "Checking build tools..."
          gcc --version || echo "Warning: gcc not found"
          pkg-config --version || echo "Warning: pkg-config not found"

      - name: Build binary
        env:
          AZURE_API_KEY: ${{ secrets.AZURE_API_KEY }}
          VISIQUATE_UPDATE_TOKEN: ${{ secrets.VISIQUATE_UPDATE_TOKEN }}
          LITCRYPT_ENCRYPT_KEY: ${{ secrets.LITCRYPT_KEY }}
        run: |
          echo "Building CCO for ${{ matrix.target }}..."

          # Build with release profile
          cargo build --release --target ${{ matrix.target }} --no-default-features

          # Create artifact directory
          mkdir -p artifacts

          # Copy binary
          cp target/${{ matrix.target }}/release/cco artifacts/cco
          chmod +x artifacts/cco

          # Create tarball
          cd artifacts
          tar -czvf ${{ matrix.artifact_name }}.tar.gz cco
          rm cco

          # Generate SHA256
          if [ "${{ runner.os }}" == "macOS" ]; then
            shasum -a 256 ${{ matrix.artifact_name }}.tar.gz > ${{ matrix.artifact_name }}.sha256
          else
            sha256sum ${{ matrix.artifact_name }}.tar.gz > ${{ matrix.artifact_name }}.sha256
          fi

          echo "Artifacts:"
          ls -la

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: artifacts/
          retention-days: 1

  # Release to visiquate/cco
  release:
    name: Create Release
    needs: build
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release

          # Move all tarballs and checksums to release dir
          find artifacts -name "*.tar.gz" -exec mv {} release/ \;
          find artifacts -name "*.sha256" -exec mv {} release/ \;

          # Create combined checksums file
          cd release
          cat *.sha256 > checksums.txt

          echo "Release files:"
          ls -la

      - name: Generate release notes
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          cat > release_notes.md <<'EOF'
          # CCO Release ${VERSION}

          ## Installation

          ### Homebrew (Recommended)

          ```bash
          # First time setup
          brew tap visiquate/cco
          brew install visiquate/cco/cco
          ```

          ### Manual Installation

          Download the appropriate binary for your platform:

          | Platform | File |
          |----------|------|
          | macOS (Apple Silicon) | `cco-aarch64-apple-darwin.tar.gz` |
          | Linux (x86_64) | `cco-x86_64-unknown-linux-gnu.tar.gz` |

          ```bash
          # Example for macOS Apple Silicon
          tar -xzf cco-aarch64-apple-darwin.tar.gz
          chmod +x cco
          sudo mv cco /usr/local/bin/
          ```

          ## Auto-Updates

          CCO includes built-in auto-updates. Start the daemon to enable hourly update checks:

          ```bash
          cco daemon start
          ```

          ## Verification

          Verify download integrity:
          ```bash
          sha256sum -c checksums.txt
          ```

          ## Documentation

          - [Installation Guide](https://github.com/visiquate/cco/blob/main/docs/INSTALLATION.md)
          - [Configuration](https://github.com/visiquate/cco/blob/main/docs/CONFIGURATION.md)
          - [CLI Reference](https://github.com/visiquate/cco/blob/main/docs/CLI_REFERENCE.md)
          - [Troubleshooting](https://github.com/visiquate/cco/blob/main/docs/TROUBLESHOOTING.md)
          EOF

          # Replace version placeholder
          sed -i "s/\${VERSION}/$VERSION/g" release_notes.md

          cat release_notes.md

      - name: Create release on visiquate/cco
        uses: softprops/action-gh-release@v2
        with:
          repository: visiquate/cco
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release/*.tar.gz
            release/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.VISIQUATE_RELEASE_TOKEN }}

      - name: Release summary
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "### Release $VERSION Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release URL: https://github.com/visiquate/cco/releases/tag/$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- cco-aarch64-apple-darwin.tar.gz (macOS ARM)" >> $GITHUB_STEP_SUMMARY
          echo "- cco-x86_64-unknown-linux-gnu.tar.gz (Linux)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Update homebrew formula SHA256 values" >> $GITHUB_STEP_SUMMARY
          echo "2. Test installation: \`brew upgrade cco\`" >> $GITHUB_STEP_SUMMARY

  # Update Homebrew formula with new SHA256 values
  update-homebrew:
    name: Update Homebrew Formula
    needs: release
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "VERSION_NUM=${{ inputs.version }}" | sed 's/^v//' >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "VERSION_NUM=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Download artifacts for SHA256
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract SHA256 values
        id: sha256
        run: |
          # Get SHA256 for each platform
          ARM64_SHA=$(cat artifacts/cco-aarch64-apple-darwin/*.sha256 | awk '{print $1}')
          X86_64_LINUX_SHA=$(cat artifacts/cco-x86_64-unknown-linux-gnu/*.sha256 | awk '{print $1}')

          echo "ARM64_SHA=$ARM64_SHA" >> $GITHUB_OUTPUT
          echo "X86_64_LINUX_SHA=$X86_64_LINUX_SHA" >> $GITHUB_OUTPUT

          echo "SHA256 values:"
          echo "  aarch64-apple-darwin: $ARM64_SHA"
          echo "  x86_64-unknown-linux-gnu: $X86_64_LINUX_SHA"

      - name: Checkout homebrew tap
        uses: actions/checkout@v4
        with:
          repository: visiquate/homebrew-cco
          token: ${{ secrets.VISIQUATE_RELEASE_TOKEN }}
          path: homebrew-cco

      - name: Update formula
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          VERSION_NUM="${{ steps.get_version.outputs.VERSION_NUM }}"
          ARM64_SHA="${{ steps.sha256.outputs.ARM64_SHA }}"
          X86_64_LINUX_SHA="${{ steps.sha256.outputs.X86_64_LINUX_SHA }}"

          cd homebrew-cco

          # Update version
          sed -i "s/version \"[^\"]*\"/version \"$VERSION_NUM\"/" Formula/cco.rb

          # Update URLs
          sed -i "s|/download/v[^/]*/cco-aarch64|/download/$VERSION/cco-aarch64|g" Formula/cco.rb
          sed -i "s|/download/v[^/]*/cco-x86_64|/download/$VERSION/cco-x86_64|g" Formula/cco.rb

          # Update SHA256 values
          # ARM64 Darwin
          sed -i "/aarch64-apple-darwin/,/sha256/{s/sha256 \"[^\"]*\"/sha256 \"$ARM64_SHA\"/}" Formula/cco.rb

          # x86_64 Linux
          sed -i "/x86_64-unknown-linux-gnu/,/sha256/{s/sha256 \"[^\"]*\"/sha256 \"$X86_64_LINUX_SHA\"/}" Formula/cco.rb

          echo "Updated formula:"
          cat Formula/cco.rb

      - name: Commit and push formula update
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          cd homebrew-cco

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add Formula/cco.rb
          git commit -m "Update CCO to $VERSION" || echo "No changes to commit"
          git push
