name: Release CCO

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2025.12.1)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: [self-hosted, linux, X64]

    steps:
      - name: Checkout release repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install cargo-sbom
        run: cargo install cargo-sbom

      - name: Build CCO binaries
        env:
          # Azure API key for model router (embedded at build time)
          AZURE_API_KEY: ${{ secrets.AZURE_API_KEY }}
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Building CCO version $VERSION..."

          # Create artifacts directory
          mkdir -p artifacts

          # Check if Azure credential will be embedded
          if [ -n "$AZURE_API_KEY" ]; then
            echo "Azure API key available - will be embedded in binary"
          else
            echo "Warning: AZURE_API_KEY not set - model routing will use fallback chain"
          fi

          # Build CCO for Linux x86_64
          echo "Building CCO..."
          cargo build --release --verbose

          # Get platform string
          PLATFORM="linux-x86_64"
          BINARY_NAME="cco-${VERSION}-${PLATFORM}"

          # Copy binary to artifacts with proper naming
          cp target/release/cco "artifacts/${BINARY_NAME}"
          chmod +x "artifacts/${BINARY_NAME}"

          # Generate checksums
          cd artifacts
          sha256sum "${BINARY_NAME}" > checksums.txt

          echo ""
          echo "Build completed"
          echo "Artifacts created:"
          ls -lh

      - name: Generate SBOM
        run: |
          echo "Generating Software Bill of Materials..."

          # CycloneDX format (preferred for vulnerability scanning)
          cargo sbom --output-format cyclone_dx_json_1_5 > artifacts/sbom-cyclonedx.json

          # SPDX format (for compliance)
          cargo sbom --output-format spdx_json_2_3 > artifacts/sbom-spdx.json

          # Add version metadata to SBOM
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          jq --arg version "$VERSION" \
             --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
             '.metadata.component.version = $version | .metadata.timestamp = $date' \
             artifacts/sbom-cyclonedx.json > artifacts/sbom-cyclonedx-tmp.json
          mv artifacts/sbom-cyclonedx-tmp.json artifacts/sbom-cyclonedx.json

          COMPONENT_COUNT=$(jq '.components | length' artifacts/sbom-cyclonedx.json)
          echo "SBOM generated with $COMPONENT_COUNT components"

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          COMPONENT_COUNT=$(jq '.components | length' artifacts/sbom-cyclonedx.json)

          cat > release_notes.md <<EOF
          # CCO Release ${VERSION}

          ## Installation

          See [installation documentation](./docs/installation.md) for details.

          ### Quick Install

          \`\`\`bash
          # Download for your platform
          curl -LO https://github.com/${{ github.repository }}/releases/download/${VERSION}/cco-${VERSION}-linux-x86_64
          chmod +x cco-${VERSION}-linux-x86_64
          mv cco-${VERSION}-linux-x86_64 /usr/local/bin/cco
          \`\`\`

          ## What's New

          - CCO command-line tool release
          - Full feature set as documented in README

          ## Security & Compliance

          - **SBOM included**: Software Bill of Materials in CycloneDX and SPDX formats
          - **Dependencies**: ${COMPONENT_COUNT} components documented
          - Verify checksums with \`sha256sum -c checksums.txt\`

          ## Documentation

          - [README](./README.md)
          - [Installation Guide](./docs/installation.md)
          - [Commands Reference](./docs/commands.md)
          - [Configuration](./docs/configuration.md)
          - [Troubleshooting](./docs/troubleshooting.md)

          EOF

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: apt-get update && apt-get install -y jq || true

      - name: Delete source code archive assets
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Removing source code archives for $VERSION..."

          # Get all assets for this release
          ASSETS=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$VERSION" \
            | jq -r '.assets[] | select(.name | endswith(".zip") or endswith(".tar.gz")) | select(.name | test("^[v]?[0-9]+\\.[0-9]+\\.[0-9]+")) | .id')

          if [ -z "$ASSETS" ]; then
            echo "No source code archives found"
          else
            echo "Found source code archives, deleting..."
            for ASSET_ID in $ASSETS; do
              echo "Deleting asset ID: $ASSET_ID"
              curl -s -X DELETE \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/releases/assets/$ASSET_ID"
              echo ""
            done
            echo "Source code archives removed"
          fi

      - name: Release summary
        run: |
          echo "### Release ${{ steps.get_version.outputs.VERSION }} Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- Binary: cco-${{ steps.get_version.outputs.VERSION }}-linux-x86_64" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM (CycloneDX): sbom-cyclonedx.json" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM (SPDX): sbom-spdx.json" >> $GITHUB_STEP_SUMMARY
          echo "- Checksums: checksums.txt" >> $GITHUB_STEP_SUMMARY
